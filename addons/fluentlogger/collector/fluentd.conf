<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<filter docker.**>
  @type record_transformer
  enable_ruby
  renew_record
  <record>
    # This is the tag we want this record to be.
    tag       ${"#{ENV['CLUSTER_NAME']}.#{record['docker.label.io.kubernetes.pod.namespace']}.#{record['docker.label.io.kubernetes.pod.name']}"}
    pod       ${record["docker.label.io.kubernetes.pod.name"]}
    container ${record["docker.label.io.kubernetes.container.name"]}
    namespace ${record["docker.label.io.kubernetes.pod.namespace"]}
    message   ${record["message"]}
  </record>
</filter>

<match docker.**>
  @type rewrite_tag_filter
  rewriterule1 tag  (.+) k8s.$1
</match>

<filter k8s.**>
  @type record_transformer
  remove_keys tag
</filter>

# Cloudwatch logs plugin.
<match k8s.**>
  @type cloudwatch_logs
  log_group_name     "#{ENV['CLUSTER_NAME']}"
  auto_create_stream true
  use_tag_as_stream  true
</match>

<match **>
  @type stdout
</match>
